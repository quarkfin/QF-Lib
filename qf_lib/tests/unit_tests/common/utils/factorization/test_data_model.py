#     Copyright 2016-present CERN â€“ European Organization for Nuclear Research
#
#     Licensed under the Apache License, Version 2.0 (the "License");
#     you may not use this file except in compliance with the License.
#     You may obtain a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
#     Unless required by applicable law or agreed to in writing, software
#     distributed under the License is distributed on an "AS IS" BASIS,
#     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#     See the License for the specific language governing permissions and
#     limitations under the License.

import unittest
from unittest import TestCase

import numpy as np
import pandas as pd

from qf_lib.containers.series.qf_series import QFSeries
from qf_lib.tests.unit_tests.common.utils.factorization.factorization_test_utils import get_analysed_tms_and_regressors

from qf_lib.common.enums.frequency import Frequency
from qf_lib.common.utils.factorization.data_models.data_model import DataModel
from qf_lib.common.utils.factorization.data_models.data_model_input import DataModelInput


class TestFactorization(TestCase):
    @classmethod
    def setUpClass(cls):
        cls.analysed_tms, cls.regressors_df = get_analysed_tms_and_regressors()
        cls.regressors_for_model = cls.regressors_df.loc[:, ['a', 'b']]

        model_input = DataModelInput(cls.regressors_for_model, cls.analysed_tms, Frequency.DAILY, is_fit_intercept=True)
        cls.data_model = DataModel(model_input)
        cls.data_model.setup()

    def test_coefficients(self):
        expected_coeffs = np.array([-0.2396, 1.2668])
        actual_coeffs = self.data_model.coefficients.values
        self.assertTrue(np.allclose(expected_coeffs, actual_coeffs, rtol=0, atol=1e-04))

    def test_intercept(self):
        self.assertAlmostEqual(0.0038391, self.data_model.intercept, delta=1e-07)

    def test_fitted_tms(self):
        expected_fit_values = [
            -0.00563, 0.01245, -0.00490, -0.01312, 0.00217, 0.00868, 0.01339, 0.04116, 0.06264, 0.02321, 0.05285,
            -0.00933, 0.02688, 0.00526, 0.01518, -0.02146, -0.00617, 0.04170, -0.05035, 0.03226, 0.03366, -0.01740,
            0.01662, 0.00757, -0.02203, 0.00288, -0.00013, 0.01394, -0.00133, 0.01796, -0.02406, -0.01798, 0.00574,
            0.00593, -0.02047, -0.03807, 0.02432, 0.02682, 0.03179, 0.04416, -0.04671, -0.06519, -0.01351, 0.00901,
            0.06473, 0.05822, 0.01376, 0.03676, 0.00637, 0.00450, 0.03245, 0.00282, 0.07269, 0.05245, -0.01969, 0.01336,
            0.00505, -0.02328, -0.02365, 0.02714, -0.04099, 0.03490, 0.06280, 0.00942, 0.02109, 0.00894, -0.02483,
            0.02887, 0.06346, 0.01267, -0.04757, 0.01680, -0.03961, 0.03000, -0.00957, 0.02487, 0.02526, -0.00939,
            0.04710, 0.01592, 0.02293, -0.01130, -0.05442, 0.01840, 0.02172, -0.00877, -0.04831, -0.03401, -0.00441,
            -0.01431, -0.00722, 0.01724, 0.00702, 0.01649, 0.01660, 0.03020, 0.01562, 0.05383, -0.02700, -0.05136,
            -0.00047, 0.01628, 0.00120, 0.04218, 0.01668, 0.04335, 0.00950, -0.01405, -0.03762, -0.03760, -0.01068,
            0.01239, 0.01171, 0.00388, -0.08348, 0.02648, 0.00979, -0.00592, 0.03835, 0.00680, 0.06339, -0.01686,
            0.03819, 0.02579, 0.05905, 0.03208, 0.01357, -0.03174, 0.01800, -0.00577, -0.02235, 0.00061, 0.00728,
            0.02002, 0.01344, 0.02543, 0.03216, 0.01302, 0.01761, 0.01075, 0.00400, 0.02262, 0.02144, 0.02118, 0.01328,
            0.03824, 0.03980, 0.01583, 0.00472, 0.00196, 0.00476, 0.04538, 0.02073, -0.02581, 0.01110, -0.00129,
            0.00150, 0.04797, -0.00191, -0.02671, -0.02947, 0.03597, 0.05970, -0.03220, -0.02020, 0.03338, -0.00152,
            0.04039, 0.00384, 0.04395, 0.00050, 0.03590, 0.03145, 0.02524, 0.03322, 0.05127, 0.02418, 0.00948, 0.00604,
            0.02843, 0.00684, 0.00333, -0.02417, 0.01526, 0.02031, -0.05072, 0.01950, 0.01381, -0.01236, 0.02132,
            -0.00696, 0.01281, 0.03739, 0.02441, 0.02719, 0.03782, -0.01178, -0.01157, -0.04082, -0.01816, 0.03553,
            0.02308, 0.03887, -0.00991, -0.01468, -0.04062, 0.00026, 0.01545, 0.01181, 0.01998, -0.00827, 0.02995,
            0.03281, -0.01050, 0.01658, -0.01485, -0.00517, 0.00556, 0.03091, -0.02005, 0.00490, 0.01996, -0.04826,
            0.03335, -0.03082, -0.04721, -0.01794, 0.02655, 0.03442, 0.03642, 0.01752, 0.00105, 0.00106, 0.03165,
            -0.03696, -0.02778, -0.00147, 0.01302, -0.01025, 0.03130, -0.01644, 0.02105, -0.00951, 0.05518, -0.00989,
            0.00528, 0.02338, 0.02850, 0.03192, -0.02819, -0.03761, 0.01380, -0.00773, -0.03259, -0.00946, -0.01963,
            -0.02289, -0.02471, 0.01102, 0.03159, -0.01509, 0.01880, -0.03742, 0.00123, -0.01298, 0.03411, 0.03130,
            0.00605, 0.00728, 0.00281, 0.03056, -0.00500, -0.02194, 0.00844, 0.02262, -0.02949, -0.00797, -0.02861,
            -0.00524, -0.00658, -0.00919, 0.03304, 0.01253, 0.01724, -0.00111, 0.01392, 0.02212, -0.00440, 0.01167,
            -0.00860, -0.02577, 0.01253, -0.00461, 0.01342, -0.02662, -0.00769, 0.02551, -0.02152, -0.00129, 0.04839,
            0.02055, 0.08147, 0.01347, 0.01905, 0.00929, -0.01176, 0.00441, 0.01026, 0.02769, 0.06409, 0.00375, 0.02848,
            0.00757, 0.00455, 0.04381, 0.02034, 0.01200, -0.01470, 0.00362, 0.05034, 0.01447, -0.03327, -0.00928,
            0.03269, 0.01973, -0.01348, 0.00060, 0.01515, 0.02720, 0.04837, 0.05091, 0.04482, 0.01117, -0.00395,
            0.00320, -0.03113, -0.02356, -0.03347, 0.00998, 0.02415, 0.00816, 0.01435, 0.06431, -0.03878, -0.05761,
            -0.02675, -0.02086, 0.00338, 0.02842, 0.01492, 0.01001, 0.02054, -0.00777, -0.00895, 0.03219, 0.02807,
            0.01613, 0.02816, 0.03772, -0.00523, -0.01675, 0.01023, 0.01049, 0.00217, 0.02855, -0.00412, 0.02290,
            0.00574, -0.00998, 0.06039, -0.01986, 0.00070, 0.02107, 0.03383, -0.04229, 0.02113, -0.01475, 0.03210,
            -0.03210, -0.00925, 0.03917, 0.01793, -0.01774, -0.00678, -0.02725, 0.04452, 0.04721, 0.02062, -0.04674,
            0.02918, -0.03464, 0.00762, -0.00361, -0.00195, 0.02937, -0.01149, -0.01719, 0.00024, 0.00893, 0.04445,
            0.01014, -0.02329, -0.04886, 0.02039, 0.02830, -0.00946, 0.02485, -0.05699, -0.05519, 0.02258, 0.03162,
            -0.00213, 0.00379, 0.00516, -0.00548, -0.01286, -0.01643, 0.03513, 0.03946, -0.02846, 0.00228, -0.04087,
            0.04085, 0.00613, 0.02900, 0.01305, 0.02358, 0.00329, 0.04345, -0.00831, -0.02322, 0.00745, 0.01904,
            -0.02490, -0.00948, -0.02937, 0.06241, 0.04898, 0.00369, -0.02908, -0.03619, 0.05626, 0.04504, -0.03188,
            0.00811, -0.04771, 0.02662, 0.01987, -0.00487, -0.00828, 0.02731, 0.02929, 0.02273, -0.03402, -0.01707,
            0.04506, 0.04962, -0.02204, 0.01994, 0.04318, -0.03125, -0.04618, 0.01010, 0.01506, 0.03389, -0.00431,
            -0.03086, -0.02520, 0.00669, 0.02667, 0.02875, 0.01748, 0.01034, -0.01445, 0.03699, 0.03035, 0.02032,
            0.02050, 0.05740, -0.00138, 0.02789, 0.00507, 0.04922, 0.02693, -0.00478, 0.00815, 0.04581, -0.00044,
            0.00902, 0.01038, 0.03619, -0.03479, 0.05504, -0.05958, 0.01033, 0.02159, 0.00171, -0.02871, -0.04119,
            0.00362, 0.03039, 0.04414, -0.04812, -0.06416, 0.04584, 0.01805, 0.00960, 0.00911, 0.01751, -0.00012,
            -0.01571, -0.00347, 0.01646, 0.01784, 0.03849, -0.04111, -0.03155, 0.00648, -0.01142, 0.03973, -0.01632,
            0.04011, -0.00482, 0.04635, 0.00679, 0.05046, 0.04267, 0.06494, 0.02510, -0.01589, -0.01523, 0.01474,
            0.01410, 0.01152, 0.03144, 0.03472, 0.03552, -0.00936, -0.05139, -0.02324, 0.02424, -0.04806, 0.03087,
            0.03162, 0.03186, -0.00456, 0.03302, 0.00876, 0.05372, 0.00884, 0.03087, 0.00424, 0.02156, -0.00360,
            0.00539, -0.00009, 0.02049, 0.03582, -0.00538, -0.00775, 0.02261, 0.00900, 0.02470, -0.03234, -0.08708,
            0.02910, -0.01653, -0.00428, -0.00352, -0.01459, -0.03684, -0.00099, 0.02531, -0.03089, -0.01848, -0.00924,
            0.01899, 0.05001, 0.01482, -0.00254, 0.00693, 0.05974, 0.00739, 0.01664, 0.01129, -0.04333, 0.04928,
            -0.01444, -0.02216, 0.02885, -0.01450, -0.00449, -0.03570, 0.01102, 0.04697, -0.03328, 0.01068, 0.02525,
            -0.00121, 0.00595, -0.01047, 0.00984, 0.01124, -0.01101, -0.00344, -0.03535, 0.02368, -0.03276, -0.03307,
            0.01407, 0.04195, 0.01004, -0.02522, 0.02677, 0.01862, 0.03271, 0.00554, -0.01529, 0.04118, -0.04162,
            0.04989, -0.04011, 0.00508, 0.01396, 0.01335, -0.00420, 0.01213, 0.01023, 0.01333, 0.01001, -0.02547,
            0.02769, -0.00607, -0.02226, -0.02611, 0.00926, -0.00700, -0.01178, -0.04529, 0.02997, 0.00642, 0.00755,
            0.03143, -0.01891, -0.00632, -0.01227, -0.01938, 0.03826, 0.00233, 0.00862, 0.02983, -0.01934, 0.00218,
            -0.03260, -0.07177, -0.00733, 0.02991, 0.01758, 0.01720, -0.02518, 0.02871, 0.00935, 0.01563, -0.02236,
            -0.01995, 0.00649, -0.00455, 0.00484, 0.02584, 0.03771, -0.00952, 0.09986, 0.02791, 0.01531, 0.02950,
            -0.02552, 0.01694, -0.01637, -0.01030, 0.03444, 0.02719, 0.02326, 0.00589, 0.01239, 0.01235, -0.01618,
            -0.00585, -0.02276, -0.01981, -0.02791, 0.05088, 0.00866, 0.03189, -0.00959, 0.02972, -0.02438, 0.00358,
            -0.02149, 0.02539, 0.02262, 0.02025, 0.03325, 0.00956, -0.01590, -0.02904, 0.04744, 0.02168, -0.00921,
            0.01680, -0.01996, -0.01032, -0.02616, -0.00827, -0.04752, 0.02690, -0.00083, -0.01306, 0.02429, -0.00859,
            0.02575, 0.02696, 0.03214, 0.00123, -0.01323, -0.01778, -0.01728, 0.01258, 0.04453, 0.00422, -0.00844,
            0.00475, 0.00244, -0.01834, 0.03240, 0.04102, 0.00662, -0.01679, -0.04960, 0.05395, -0.04399, 0.00139,
            0.04125, -0.00919, -0.00425, -0.00087, 0.03697, 0.02057, -0.00998, 0.01279, 0.00329, 0.00950, 0.02513,
            -0.00100, 0.00730, 0.00589, -0.01415, -0.00588, -0.00629, 0.01410, 0.00781, 0.02366, -0.01769, 0.02491,
            0.03450, 0.07212, 0.01409, -0.02257, 0.00427, -0.04072, 0.00325, 0.01928, 0.00211, -0.01519, -0.02790,
            0.03871, -0.00820, -0.01623, -0.00702, 0.03692, 0.02451, 0.03386, 0.00111, 0.03516, 0.00275, 0.00206,
            0.00483, -0.02131, -0.01250, 0.03063, 0.05235, 0.03141, -0.01651, 0.06436, -0.01112, -0.02562, -0.01288,
            -0.02985, -0.00825, 0.00038, -0.02176, 0.00481, 0.00919, -0.02791, 0.02385, -0.02839, 0.00063, 0.01471,
            0.01855, 0.00079, 0.02227, 0.02837, 0.03234, 0.01860, -0.02415, 0.03580, -0.00927, -0.00557, -0.03020,
            0.00959, 0.03346, -0.00463, 0.01416, 0.03035, 0.01110, -0.00587, 0.00847, -0.03155, 0.03975, 0.00591,
            0.03910, 0.02561, -0.02393, 0.00178, -0.01659, -0.01990, 0.03382, 0.02707, 0.00401, 0.01171, 0.00049,
            0.02655, -0.01648, 0.01121, -0.00271, 0.01867, -0.00315, 0.01297, -0.00427, 0.01715, 0.01223, 0.04506,
            -0.02155, 0.03671, -0.00988, 0.06423, 0.00523, -0.02609, 0.01928, 0.06269, 0.00098, -0.01624, -0.04654,
            -0.04622, -0.03533, 0.00634, 0.01886, -0.01355, 0.00975, -0.04284, -0.00675, 0.03507, 0.01286, 0.01701,
            -0.03541, 0.00874, -0.00353, -0.01887, 0.00512, -0.01232, 0.02638, -0.04066, 0.02735, -0.00895, -0.00423,
            0.01420, -0.01243, -0.01884, 0.02451, 0.00185, -0.01285, -0.01789, 0.03928, -0.00537, -0.00404, 0.01141,
            0.02544, 0.00732, -0.02288, 0.05036, -0.02586, -0.03357, -0.02991, 0.02126, 0.00216, 0.01926, -0.00365,
            0.01410, 0.04127, -0.02630, 0.01628, -0.01740, 0.00656, -0.00299, 0.03177, -0.01325, 0.02553, -0.00070,
            0.02514, 0.02879, 0.03203, 0.04983, -0.00308, -0.01339, -0.01923, 0.02727, 0.03723, 0.03067, 0.00644,
            0.02859, -0.00019, -0.01858, -0.02403, 0.00699, 0.04147, -0.02667, 0.02217, 0.02447, -0.01079, -0.00454,
            -0.00103, 0.01124, 0.00257, 0.00321, 0.01160, -0.00995, -0.01131, -0.07888, 0.00035, -0.02166, -0.03412,
            0.05386, 0.01651, -0.00802, -0.02803, -0.01499, -0.01638, -0.00154, -0.03127, 0.00178, -0.00419, 0.00523,
            0.02343, 0.02993, 0.03092, 0.01268, 0.00437, 0.00032, -0.01965, -0.00261, -0.00997, 0.02838, -0.00373,
            0.02402, -0.00860, 0.02294, -0.01401, 0.02051, 0.02406, -0.01807, -0.00333, 0.00538, 0.02318, 0.00007,
            0.00197, 0.00862, -0.00757, 0.00303, 0.00246, -0.01695, 0.02351, 0.02972, -0.01411, 0.01069, -0.01311,
            0.03031, 0.03435, 0.01352, 0.05583, -0.00258, 0.01544
        ]
        expected_dates = self.data_model.input_data.analysed_tms.index

        actual_fit_tms = self.data_model.fitted_tms

        self.assertTrue(np.allclose(expected_fit_values, actual_fit_tms, rtol=0, atol=1e-05))
        self.assertTrue(all(expected_dates == actual_fit_tms.index))

    def test_risk_contribution(self):
        expected_risk_contrib = [0.0380651273069620, 0.961934872693038]
        actual_risk_contrib = self.data_model.risk_contribution.values
        self.assertTrue(np.allclose(expected_risk_contrib, actual_risk_contrib, rtol=0, atol=1e-14))

    def test_performance_attribution(self):
        expected_factors_performance_attributions = [-0.250053130993001, 0.742491223922294]
        actual_factors_performance_attributions = self.data_model.factors_performance_attribution_ret
        self.assertTrue(np.allclose(expected_factors_performance_attributions,
                                    actual_factors_performance_attributions,
                                    rtol=0, atol=1e-14))

    def test_durbin_watson(self):
        expected_value = 2.073489557060493
        actual_value = self.data_model.durbin_watson_test
        self.assertAlmostEqual(expected_value, actual_value, delta=1e-14)

    def test_autocorrelation(self):
        expected_value = [False, False, False]
        actual_value = self.data_model.autocorrelation
        self.assertTrue(np.array_equal(expected_value, actual_value))

    def test_heteroskedasticity(self):
        expected_value = 0.00964796935924
        actual_value = self.data_model.heteroskedasticity
        self.assertAlmostEqual(actual_value, expected_value, places=12)

    def test_correlation_matrix(self):
        expected_matrix = pd.DataFrame(
            data=[[1.0000, -0.2047, 0.9826, 0.7897],
                  [-0.2047, 1.0000, -0.0191, -0.1616],
                  [0.9826, -0.0191, 1.0000, 0.7760],
                  [0.7897, -0.1616, 0.7760, 1.0000]],
            index=["Fitted returns", "a", "b", "Fund"],
            columns=["Fitted returns", "a", "b", "Fund"])
        actual_matrix = self.data_model.correlation_matrix

        self.assertTrue(np.allclose(expected_matrix.values, actual_matrix.values, rtol=0, atol=1e-04))
        self.assertTrue(all(expected_matrix.index.values == actual_matrix.index.values))
        self.assertTrue(all(expected_matrix.columns.values == actual_matrix.columns.values))

    def test_condition_number(self):
        expected_cond_number = 1.0159
        actual_cond_number = self.data_model.condition_number
        self.assertAlmostEqual(expected_cond_number, actual_cond_number, delta=1e-04)

    def test_r_squared_of_each_predictor(self):
        actual_r_squared = self.data_model.r_squared_of_each_predictor
        expected_r_squared = QFSeries(index=['a', 'b'], data=[0.00036403, 0.00036403])

        self.assertTrue(np.allclose(expected_r_squared.values, actual_r_squared.values, rtol=0, atol=1e-04))
        self.assertTrue(all(expected_r_squared.index.values == actual_r_squared.index.values))

    def test_cooks_distance_tms(self):
        expected_values = np.array([
            0.00002, 0.00012, 0.00288, 0.00061, 0.00023, 0.00080, 0.00005, 0.00041, 0.00021, 0.00017,
            0.00001, 0.00006, 0.00022, 0.00036, 0.00005, 0.00202, 0.00101, 0.00017, 0.00087, 0.00018,
            0.00041, 0.00043, 0.00003, 0.00116, 0.00207, 0.00016, 0.00011, 0.00000, 0.00067, 0.00001,
            0.00082, 0.00007, 0.00101, 0.00003, 0.00467, 0.00010, 0.00001, 0.00038, 0.00022, 0.00024,
            0.00250, 0.00041, 0.00026, 0.00935, 0.00119, 0.00008, 0.00024, 0.00002, 0.00002, 0.00056,
            0.00027, 0.00051, 0.00048, 0.00000, 0.00044, 0.00080, 0.00065, 0.00012, 0.00127, 0.00016,
            0.00055, 0.00001, 0.00068, 0.00000, 0.00171, 0.00000, 0.00059, 0.00170, 0.00478, 0.00005,
            0.00131, 0.00054, 0.00142, 0.00041, 0.00154, 0.00001, 0.00100, 0.00115, 0.00154, 0.00008,
            0.00017, 0.00371, 0.00817, 0.00131, 0.00249, 0.00002, 0.00113, 0.00203, 0.00037, 0.00051,
            0.00056, 0.00000, 0.00003, 0.00018, 0.00517, 0.00035, 0.00105, 0.00038, 0.00296, 0.00148,
            0.00042, 0.00002, 0.00117, 0.00076, 0.00001, 0.00005, 0.00202, 0.00103, 0.00153, 0.00040,
            0.00071, 0.00001, 0.00016, 0.00020, 0.04242, 0.00002, 0.00011, 0.00468, 0.00017, 0.00007,
            0.00446, 0.00104, 0.00012, 0.00241, 0.00210, 0.00030, 0.00021, 0.00040, 0.00001, 0.00064,
            0.00040, 0.00113, 0.00020, 0.00081, 0.00025, 0.00001, 0.00024, 0.00116, 0.00482, 0.00000,
            0.00017, 0.00021, 0.00074, 0.00176, 0.00003, 0.00000, 0.00027, 0.00006, 0.00053, 0.00070,
            0.00189, 0.00292, 0.00190, 0.00055, 0.00004, 0.00000, 0.00072, 0.00236, 0.00010, 0.00000,
            0.00105, 0.00459, 0.00006, 0.00008, 0.00071, 0.00089, 0.00018, 0.00004, 0.00079, 0.00059,
            0.00024, 0.00002, 0.00007, 0.00000, 0.00028, 0.00002, 0.00170, 0.00033, 0.00009, 0.00022,
            0.00000, 0.00126, 0.00072, 0.00063, 0.00080, 0.00055, 0.00059, 0.00030, 0.00109, 0.00007,
            0.00430, 0.00006, 0.00072, 0.00013, 0.00056, 0.00000, 0.00044, 0.00179, 0.00440, 0.00005,
            0.00017, 0.00251, 0.00012, 0.00064, 0.00068, 0.00112, 0.00000, 0.00431, 0.00123, 0.00038,
            0.00021, 0.00125, 0.00070, 0.00111, 0.00001, 0.00214, 0.00003, 0.00279, 0.00000, 0.00078,
            0.00000, 0.00000, 0.00166, 0.00034, 0.00066, 0.00624, 0.00026, 0.00075, 0.00003, 0.00102,
            0.00053, 0.00065, 0.00007, 0.00403, 0.00150, 0.00016, 0.00004, 0.00070, 0.00017, 0.00018,
            0.00002, 0.00002, 0.00378, 0.00207, 0.00015, 0.00026, 0.00005, 0.00026, 0.00013, 0.00120,
            0.00673, 0.00086, 0.00095, 0.00359, 0.00144, 0.00037, 0.00169, 0.00146, 0.00100, 0.00000,
            0.00066, 0.00006, 0.00102, 0.00071, 0.00001, 0.00022, 0.00066, 0.00327, 0.00011, 0.00038,
            0.00023, 0.00001, 0.00059, 0.00001, 0.00061, 0.00003, 0.00003, 0.00007, 0.00016, 0.00008,
            0.00032, 0.00046, 0.00043, 0.00014, 0.00002, 0.00062, 0.00086, 0.00146, 0.00180, 0.00031,
            0.00129, 0.00005, 0.00016, 0.00110, 0.00018, 0.00192, 0.00061, 0.00384, 0.00002, 0.00279,
            0.00005, 0.00448, 0.00006, 0.00018, 0.00000, 0.00042, 0.00003, 0.00069, 0.00001, 0.00341,
            0.00005, 0.00002, 0.00066, 0.00051, 0.00082, 0.00004, 0.00002, 0.00031, 0.00000, 0.00006,
            0.00106, 0.00120, 0.00028, 0.00112, 0.00192, 0.00020, 0.00000, 0.00079, 0.00015, 0.00106,
            0.00005, 0.00060, 0.00015, 0.00044, 0.00006, 0.00165, 0.00081, 0.00453, 0.00030, 0.00098,
            0.00039, 0.00045, 0.00677, 0.00061, 0.00069, 0.00108, 0.00099, 0.00000, 0.00126, 0.00001,
            0.00019, 0.00020, 0.00128, 0.00016, 0.00109, 0.00017, 0.00008, 0.00034, 0.00002, 0.00010,
            0.00024, 0.00047, 0.00008, 0.00014, 0.00207, 0.00000, 0.00080, 0.00031, 0.00017, 0.00129,
            0.00096, 0.00037, 0.00103, 0.00082, 0.00118, 0.00000, 0.00262, 0.00111, 0.00000, 0.00005,
            0.00037, 0.00009, 0.00036, 0.00387, 0.00014, 0.00091, 0.00203, 0.00000, 0.01290, 0.00323,
            0.01341, 0.00852, 0.00008, 0.00121, 0.00101, 0.00013, 0.00002, 0.00057, 0.00006, 0.00035,
            0.00034, 0.00029, 0.00154, 0.00200, 0.00004, 0.00018, 0.00110, 0.00007, 0.00000, 0.00050,
            0.00053, 0.00009, 0.00007, 0.00002, 0.00010, 0.00000, 0.00055, 0.00002, 0.00018, 0.00038,
            0.00001, 0.00015, 0.00269, 0.00094, 0.00085, 0.00101, 0.00108, 0.00095, 0.00130, 0.00047,
            0.00537, 0.00060, 0.00022, 0.00208, 0.00067, 0.00108, 0.00019, 0.00018, 0.00019, 0.00037,
            0.00038, 0.00397, 0.00021, 0.00017, 0.00016, 0.00492, 0.00160, 0.00069, 0.00077, 0.00634,
            0.00000, 0.00030, 0.00067, 0.00131, 0.00238, 0.00062, 0.00668, 0.00280, 0.00039, 0.00159,
            0.00003, 0.00003, 0.00001, 0.00062, 0.00026, 0.00037, 0.00000, 0.00009, 0.00000, 0.00015,
            0.00420, 0.00166, 0.00212, 0.00041, 0.00000, 0.00049, 0.00010, 0.00050, 0.00109, 0.00023,
            0.00000, 0.00011, 0.00000, 0.00021, 0.00000, 0.00015, 0.00000, 0.00001, 0.00001, 0.00080,
            0.00191, 0.00274, 0.00230, 0.00633, 0.00006, 0.00009, 0.00058, 0.00023, 0.00320, 0.00123,
            0.00001, 0.00034, 0.01410, 0.02883, 0.00313, 0.00337, 0.00013, 0.00012, 0.00025, 0.00001,
            0.00058, 0.00055, 0.00015, 0.00268, 0.00052, 0.00156, 0.00006, 0.00009, 0.00024, 0.00078,
            0.00062, 0.00014, 0.00000, 0.00171, 0.00035, 0.00074, 0.00024, 0.00047, 0.00034, 0.00019,
            0.00060, 0.00053, 0.00045, 0.00206, 0.00002, 0.00000, 0.00201, 0.00019, 0.01817, 0.00343,
            0.00024, 0.00076, 0.00000, 0.00011, 0.00003, 0.00029, 0.00014, 0.00004, 0.00245, 0.00050,
            0.00075, 0.00074, 0.00137, 0.00031, 0.00000, 0.00036, 0.00010, 0.00032, 0.00043, 0.00036,
            0.00189, 0.00007, 0.00001, 0.00218, 0.00654, 0.00047, 0.00101, 0.00001, 0.00223, 0.00184,
            0.00033, 0.00001, 0.00000, 0.00126, 0.00007, 0.00013, 0.00011, 0.00082, 0.00096, 0.00025,
            0.00044, 0.00296, 0.00007, 0.00002, 0.00022, 0.00416, 0.00001, 0.00033, 0.00026, 0.00031,
            0.00013, 0.00006, 0.00000, 0.00028, 0.00047, 0.00156, 0.00015, 0.00037, 0.00002, 0.00011,
            0.00004, 0.00020, 0.00086, 0.00029, 0.00062, 0.00376, 0.00009, 0.00019, 0.00210, 0.00029,
            0.00153, 0.00247, 0.00076, 0.00149, 0.00111, 0.00038, 0.00155, 0.00027, 0.00186, 0.00511,
            0.00151, 0.00116, 0.00021, 0.00102, 0.00002, 0.00127, 0.00002, 0.00001, 0.00002, 0.00130,
            0.00034, 0.00160, 0.00053, 0.00663, 0.00027, 0.00000, 0.00014, 0.00224, 0.00484, 0.00023,
            0.00007, 0.00530, 0.00051, 0.00000, 0.00018, 0.00025, 0.00115, 0.00002, 0.00002, 0.00077,
            0.00141, 0.00004, 0.00083, 0.00085, 0.00080, 0.00014, 0.00190, 0.00096, 0.00445, 0.00019,
            0.00271, 0.00124, 0.00249, 0.00006, 0.00018, 0.00166, 0.00002, 0.00046, 0.00287, 0.00003,
            0.00070, 0.00125, 0.00100, 0.00038, 0.00118, 0.00018, 0.00261, 0.00047, 0.00073, 0.00173,
            0.00003, 0.00071, 0.00002, 0.00044, 0.00024, 0.00148, 0.00161, 0.00014, 0.00168, 0.00045,
            0.00032, 0.00393, 0.00010, 0.00017, 0.00001, 0.00244, 0.00123, 0.00371, 0.00056, 0.00047,
            0.00047, 0.00151, 0.00018, 0.00006, 0.00422, 0.00156, 0.00463, 0.00009, 0.00016, 0.00075,
            0.00042, 0.00028, 0.00243, 0.00005, 0.00012, 0.00203, 0.00001, 0.00064, 0.00017, 0.00037,
            0.00024, 0.00056, 0.00000, 0.00002, 0.00118, 0.00238, 0.00074, 0.00076, 0.00067, 0.00019,
            0.00072, 0.00026, 0.00436, 0.00012, 0.00035, 0.00014, 0.00088, 0.00195, 0.00028, 0.00122,
            0.00166, 0.00000, 0.00021, 0.00214, 0.00015, 0.00157, 0.00024, 0.00014, 0.00035, 0.00001,
            0.00002, 0.00256, 0.00001, 0.00000, 0.00025, 0.00007, 0.00014, 0.00003, 0.00000, 0.00001,
            0.00440, 0.00036, 0.00033, 0.00003, 0.00180, 0.00001, 0.00268, 0.00050, 0.00005, 0.00032,
            0.00003, 0.00508, 0.00018, 0.00351, 0.00024, 0.00039, 0.00000, 0.00215, 0.00041, 0.00038,
            0.00015, 0.00013, 0.00005, 0.00042, 0.00000, 0.00028, 0.00020, 0.00013, 0.00243, 0.00041,
            0.00032, 0.00009, 0.00629, 0.00066, 0.00539, 0.00001, 0.00111, 0.00152, 0.00207, 0.00000,
            0.00144, 0.00019, 0.00269, 0.00010, 0.00089, 0.00081, 0.00015, 0.00057, 0.00138, 0.00217,
            0.00043, 0.00007, 0.00019, 0.00091, 0.00016, 0.00046, 0.00035, 0.01210, 0.00002, 0.00082,
            0.00000, 0.00079, 0.00016, 0.00026, 0.00000, 0.00002, 0.00016, 0.00473, 0.00078, 0.00145,
            0.00102, 0.00164, 0.00243, 0.00351, 0.00028, 0.00022, 0.00053, 0.00002, 0.00011, 0.00007,
            0.00003, 0.00147, 0.00084, 0.00145, 0.00000, 0.00002, 0.00098, 0.00004, 0.00080, 0.00001,
            0.00108, 0.00352, 0.00003, 0.00063, 0.00231, 0.00013, 0.00033, 0.00009, 0.00163, 0.00030,
            0.00014, 0.00027, 0.00110, 0.00110, 0.00036, 0.00554, 0.00012, 0.00281, 0.00192, 0.00102,
            0.00002, 0.00003, 0.00035, 0.00063, 0.00183, 0.00017, 0.00000, 0.00058, 0.00072, 0.00413,
            0.00391, 0.00081, 0.00005, 0.00000, 0.00048, 0.00006, 0.01048, 0.00097, 0.00000, 0.00015,
            0.00023, 0.00777, 0.00008, 0.00006, 0.00001, 0.00118, 0.00555, 0.00013, 0.00068, 0.00094,
            0.00016, 0.00001, 0.00238, 0.00000, 0.00006, 0.00004, 0.00069, 0.00040, 0.00025, 0.00184,
            0.00006, 0.00105, 0.00219, 0.00000, 0.00013, 0.00043, 0.00203, 0.00027, 0.00085, 0.00053,
            0.00057, 0.00001, 0.00136, 0.00016, 0.00525, 0.00034, 0.00069, 0.00129, 0.00027, 0.00009,
            0.00001, 0.00144, 0.00300, 0.00006, 0.00275, 0.00290, 0.00047, 0.00113, 0.00009, 0.00006,
            0.00001, 0.00005, 0.00262, 0.00013, 0.00016, 0.00068, 0.00011, 0.00046, 0.00027, 0.00166,
            0.00647, 0.00055, 0.00137, 0.00154, 0.00065, 0.00023, 0.00004, 0.00238, 0.00195, 0.00114,
            0.00103, 0.00000, 0.00149, 0.00031, 0.00049, 0.00024, 0.00000, 0.00005, 0.00120, 0.00000,
            0.00001, 0.00021, 0.00131, 0.00011, 0.00040, 0.00151, 0.00088, 0.00020, 0.00042, 0.00016,
            0.00005, 0.00060, 0.00009, 0.00511, 0.00006, 0.00005, 0.00068, 0.00083, 0.00378, 0.00301,
            0.00132, 0.00000, 0.00101, 0.00000, 0.00007, 0.00023, 0.00106, 0.00201, 0.00008, 0.00030])

        actual_cooks_distance_tms = self.data_model.cooks_distance_tms
        actual_values = actual_cooks_distance_tms.values
        self.assertTrue(np.allclose(expected_values, actual_values, rtol=0, atol=1e-05))
        self.assertTrue(all(self.analysed_tms.index.values == actual_cooks_distance_tms.index.values))


if __name__ == '__main__':
    unittest.main()
